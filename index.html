<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LiveStock</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#0a0e27;color:#e8eaed;min-height:100vh}
@keyframes gridMove{0%{transform:translate(0,0)}100%{transform:translate(50px,50px)}}
@keyframes rot{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
.bgpat{position:fixed;inset:0;opacity:.03;background-image:linear-gradient(90deg,#00ff88 1px,transparent 1px),linear-gradient(0deg,#00ff88 1px,transparent 1px);background-size:50px 50px;animation:gridMove 20s linear infinite;pointer-events:none;z-index:0}
.wrap{position:relative;z-index:1;max-width:1400px;margin:0 auto;padding:20px}
.card{background:#1a2142;border:2px solid #2d3561;border-radius:16px;padding:22px}
.srow{background:#151b3d;border:1px solid #2d3561;border-radius:12px;padding:14px 14px 14px 46px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;position:relative;transition:all .2s}
.srow:hover{border-color:#00ff88;transform:translateX(4px)}
.news-card{background:#151b3d;border-left:4px solid #00ff88;border-radius:8px;padding:15px 16px;margin-bottom:12px;transition:all .2s}
.news-card:hover{background:rgba(0,0,0,.3);transform:translateX(4px)}
.trend-card{background:#151b3d;border:1px solid #2d3561;border-radius:12px;padding:15px 16px;margin-bottom:10px;transition:all .2s}
.trend-card:hover{border-color:#3498db;transform:translateY(-2px);box-shadow:0 5px 15px rgba(52,152,219,.15)}
.ai-btn{display:inline-flex;align-items:center;gap:6px;background:rgba(52,152,219,.1);border:1px solid #3498db;color:#3498db;padding:5px 11px;border-radius:6px;font-size:.75em;font-weight:700;cursor:pointer;margin-top:10px;transition:all .2s}
.ai-btn:disabled{background:rgba(0,255,136,.08);border-color:#00ff88;color:#00ff88;cursor:default}
.ai-panel{margin-top:12px;padding:12px 14px;background:rgba(52,152,219,.07);border:1px solid rgba(52,152,219,.25);border-radius:8px;animation:fadeIn .4s ease}
.spin{width:10px;height:10px;border:2px solid #2d3561;border-top-color:#00ff88;border-radius:50%;animation:rot .7s linear infinite;display:inline-block;flex-shrink:0}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(5px);z-index:1000;display:flex;justify-content:center;align-items:center;padding:20px}
.modal-box{background:#1a2142;border:2px solid #2d3561;border-radius:16px;padding:28px;max-width:600px;width:100%;max-height:82vh;overflow-y:auto;position:relative}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:22px;margin-bottom:22px}
@media(max-width:700px){.grid2{grid-template-columns:1fr}}
input{background:#151b3d;border:2px solid #2d3561;color:#e8eaed;padding:13px 17px;border-radius:10px;font-size:.97em;font-family:Arial,sans-serif;outline:none;flex:1;transition:border-color .2s}
input:focus{border-color:#00ff88}
.btn-g{background:#00ff88;color:#0a0e27;border:none;padding:13px 26px;border-radius:10px;font-size:.97em;font-weight:700;cursor:pointer;white-space:nowrap}
.btn-g:disabled{opacity:.5;cursor:not-allowed}
.chip{background:rgba(0,255,136,.1);border:1px solid #00ff88;color:#00ff88;padding:4px 11px;border-radius:20px;font-size:.79em;font-weight:600}
#sDrop{position:absolute;top:100%;left:0;right:0;background:#1a2142;border:1px solid #2d3561;border-top:none;border-radius:0 0 10px 10px;z-index:200;max-height:260px;overflow-y:auto;display:none}
.sug{padding:10px 14px;cursor:pointer;font-size:.9em;display:flex;justify-content:space-between;transition:background .15s}
.sug:hover{background:#151b3d}
.sect-btn{background:#151b3d;border:2px solid #2d3561;border-radius:12px;padding:20px;cursor:pointer;text-align:center;transition:all .25s;user-select:none}
.sect-btn:hover{border-color:#00ff88}
.sect-btn.on{background:rgba(0,255,136,.1);border-color:#00ff88;box-shadow:0 0 20px rgba(0,255,136,.2)}
.empty{text-align:center;padding:32px;color:#9ba3af}
.err{color:#ff4757;font-size:.85em;margin-top:8px;padding:8px 12px;background:rgba(255,71,87,.1);border-radius:6px;border:1px solid rgba(255,71,87,.3)}
</style>
</head>
<body>
<div class="bgpat"></div>

<!-- â•â•â•â•â•â•â•â•â•â• SETUP â•â•â•â•â•â•â•â•â•â• -->
<div id="setupScreen" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;z-index:1">
  <div class="card" style="max-width:700px;width:100%;padding:48px;box-shadow:0 20px 60px rgba(0,0,0,.5)">
    <div style="font-size:2.2em;font-weight:700;color:#00ff88;margin-bottom:8px;letter-spacing:2px">&#128200; LIVESTOCK</div>
    <p style="color:#9ba3af;margin-bottom:36px;font-size:1.05em">Real-time market intelligence. Pick your sectors to personalise your dashboard.</p>
    <div id="sectGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:14px;margin-bottom:30px"></div>
    <button id="startBtn" onclick="startApp()" disabled
      style="width:100%;background:#2d3561;color:#4a5568;border:none;padding:17px;border-radius:12px;font-size:1.08em;font-weight:700;cursor:not-allowed;letter-spacing:1px;transition:all .25s">
      START TRACKING
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â• -->
<div id="appScreen" style="display:none">
<div class="wrap">

  <!-- HEADER -->
  <div class="card" style="padding:22px 28px;margin-bottom:22px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">
    <div>
      <div style="font-size:1.75em;font-weight:700;color:#00ff88;letter-spacing:2px">&#128200; LIVESTOCK</div>
      <div style="display:inline-flex;align-items:center;gap:6px;background:rgba(0,255,136,.1);border:1px solid #00ff88;padding:4px 11px;border-radius:20px;font-size:.79em;font-weight:600;margin-top:6px">
        <span style="width:7px;height:7px;background:#00ff88;border-radius:50%;animation:blink 2s infinite;display:inline-block"></span>
        LIVE
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <div id="hChips" style="display:flex;gap:7px;flex-wrap:wrap"></div>
      <button onclick="toggleWLPanel()" style="background:#151b3d;border:2px solid #ffd93d;color:#ffd93d;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:.87em;font-weight:600">
        &#11088; Watchlist <span id="wlBadge"></span>
      </button>
      <button onclick="goSetup()" style="background:#151b3d;border:2px solid #2d3561;color:#e8eaed;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:.87em;font-weight:600">&#9881; Settings</button>
    </div>
  </div>

  <!-- WATCHLIST PANEL -->
  <div id="wlPanel" style="display:none;margin-bottom:22px">
    <div class="card">
      <div style="font-weight:700;font-size:1.1em;margin-bottom:16px">&#11088; Watchlist</div>
      <div id="wlItems"><div class="empty">Star any stock with &#9734; to add it here</div></div>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="card" style="margin-bottom:22px">
    <div style="background:rgba(52,152,219,.1);border:1px solid #3498db;padding:10px 14px;border-radius:8px;margin-bottom:13px;font-size:.86em">
      &#128269; <strong>Search any stock in the world</strong> â€” type a ticker (AAPL, TSLA) or company name. Live data fetched instantly.
    </div>
    <div style="display:flex;gap:9px;position:relative">
      <div style="position:relative;flex:1">
        <input id="sInput" placeholder="Type any ticker or company name..." oninput="onType()" onkeydown="if(event.key==='Enter')doSearch()" onblur="setTimeout(closeDrop,200)">
        <div id="sDrop"></div>
      </div>
      <button class="btn-g" id="sBtn" onclick="doSearch()">Search</button>
    </div>
    <div id="sResults"></div>
  </div>

  <!-- PORTFOLIO + TRENDS -->
  <div class="grid2">
    <div class="card">
      <div style="font-weight:700;font-size:1.1em;margin-bottom:16px;display:flex;align-items:center;gap:9px">
        &#127919; Your Portfolio
        <span style="background:rgba(0,255,136,.1);border:1px solid #00ff88;color:#00ff88;padding:1px 7px;border-radius:4px;font-size:.6em;font-weight:700">LIVE</span>
      </div>
      <div id="portItems"></div>
    </div>
    <div class="card">
      <div style="font-weight:700;font-size:1.1em;margin-bottom:16px">&#128202; Market Trends</div>
      <div id="trendCont"></div>
    </div>
  </div>

  <!-- NEWS -->
  <div class="card" style="margin-bottom:30px">
    <div style="font-weight:700;font-size:1.1em;margin-bottom:16px">&#128240; Market News</div>
    <div id="newsCont"></div>
  </div>

</div>
</div>

<!-- MODAL -->
<div id="modalBg" class="modal-bg" style="display:none" onclick="closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <button onclick="closeModal()" style="position:absolute;top:16px;right:16px;background:#151b3d;border:2px solid #2d3561;color:#e8eaed;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1.3em">&#215;</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
// â”€â”€â”€ SECTOR CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// These are just the default tickers shown in your portfolio â€” NOT a hardcoded search list
const SECTORS = {
  technology:    { icon:"ðŸ’»", tickers:["AAPL","MSFT","NVDA","GOOGL","META"] },
  food:          { icon:"ðŸ”", tickers:["MCD","SBUX","KO","PEP","CMG"] },
  healthcare:    { icon:"âš•ï¸", tickers:["JNJ","UNH","LLY","PFE","ABBV"] },
  finance:       { icon:"ðŸ’°", tickers:["JPM","BAC","GS","V","MA"] },
  energy:        { icon:"âš¡", tickers:["XOM","CVX","COP","SLB","EOG"] },
  retail:        { icon:"ðŸ›ï¸", tickers:["AMZN","WMT","HD","COST","TGT"] },
  automotive:    { icon:"ðŸš—", tickers:["TSLA","F","GM","TM","RIVN"] },
  entertainment: { icon:"ðŸŽ¬", tickers:["DIS","NFLX","SPOT","WBD","RBLX"] },
};

const NEWS = [
  {id:1,title:"Tech Giants Report Strong Q4 Earnings Amid AI Boom",source:"Financial Times",time:"2h ago",cat:"Technology",summary:"Major technology companies exceeded analyst expectations, driven by AI investments and cloud computing growth.",sectors:["technology"],prompt:"Tech Giants Q4 earnings beat driven by AI and cloud â€” Apple, Microsoft, Google, Nvidia all outperformed. Which stocks benefit most, valuation impact, and key risks?"},
  {id:2,title:"Fast Food Chains Embrace Sustainability Initiatives",source:"Bloomberg",time:"4h ago",cat:"Food",summary:"Leading restaurant brands announce ambitious plans to reduce environmental impact.",sectors:["food"],prompt:"McDonald's, Starbucks, Chipotle launching major sustainability drives. Cost impact on margins, ESG appeal, and which chains are best positioned?"},
  {id:3,title:"Breakthrough Gene Therapy Receives FDA Approval",source:"Medical News Today",time:"1h ago",cat:"Healthcare",summary:"New CRISPR treatment marks a significant milestone in personalised medicine.",sectors:["healthcare"],prompt:"FDA approves CRISPR-based gene therapy. Which biotech stocks are affected, market size, and regulatory precedent?"},
  {id:4,title:"Major Banks Announce Digital Transformation Push",source:"Wall Street Journal",time:"3h ago",cat:"Finance",summary:"Banks investing billions in fintech capabilities to compete with digital challengers.",sectors:["finance"],prompt:"JPMorgan, Goldman, BofA investing billions in fintech. Which banks are best positioned, fintech risk, and ROI timeline?"},
  {id:5,title:"Renewable Energy Investment Reaches Record Levels",source:"Energy Today",time:"5h ago",cat:"Energy",summary:"Global solar and wind investment surpasses fossil fuel spending for the first time.",sectors:["energy"],prompt:"Renewable energy investment surpasses fossil fuels globally. Energy stocks most affected, policy tailwinds, and transition risks for oil majors?"},
  {id:6,title:"E-Commerce Giants Battle for Same-Day Delivery",source:"Retail Week",time:"6h ago",cat:"Retail",summary:"Amazon, Walmart and Target expand rapid delivery networks.",sectors:["retail"],prompt:"Amazon, Walmart, Target racing to build same-day delivery infrastructure. Capex burden, competitive moat, and who has the edge?"},
  {id:7,title:"Electric Vehicle Sales Surge Past Expectations",source:"Automotive News",time:"3h ago",cat:"Automotive",summary:"EVs now account for 30% of new car sales globally.",sectors:["automotive"],prompt:"EV market share hits 30% of new car sales. Tesla vs legacy OEM positioning, battery supply chain, and biggest risk to growth?"},
  {id:8,title:"Streaming Services Report Mixed Results",source:"Entertainment Weekly",time:"4h ago",cat:"Entertainment",summary:"Netflix gains subscribers while competitors struggle with profitability.",sectors:["entertainment"],prompt:"Netflix growing while Disney+, Paramount, WBD struggle. Consolidation likelihood, stocks to watch, and what saturation signals?"},
];

const TRENDS = [
  {id:"t1",title:"AI Integration Boom",desc:"Enterprises adopting AI rapidly â€” 40% YoY growth in AI spending",sectors:["technology"],prompt:"Enterprise AI adoption boom with NVIDIA, Microsoft Azure AI, Google Cloud AI. Which stocks benefit most and key risks?"},
  {id:"t2",title:"Cloud Migration Accelerates",desc:"78% of companies now cloud-first with multi-cloud strategies",sectors:["technology"],prompt:"Cloud-first adoption with multi-cloud across AWS, Azure, GCP. Competitive dynamics, margin implications, and top stock picks?"},
  {id:"t3",title:"Plant-Based Revolution",desc:"Alternative protein market growing 35% annually",sectors:["food"],prompt:"Plant-based food market growing 35% YoY. Who wins, who loses among food stocks, and profitability outlook?"},
  {id:"t4",title:"Telehealth Goes Mainstream",desc:"Virtual care now 40% of all consultations",sectors:["healthcare"],prompt:"Telehealth now 40% of consultations. Reimbursement trends, competitive moats, and key investment plays?"},
  {id:"t5",title:"Embedded Finance Growth",desc:"Non-financial companies offering banking â€” a $7T opportunity by 2030",sectors:["finance"],prompt:"Embedded finance: Apple, Amazon, Shopify offering banking. Disruption risk to traditional banks and top stock plays?"},
  {id:"t6",title:"Green Hydrogen Boom",desc:"Hydrogen infrastructure investment up 300% as decarbonisation accelerates",sectors:["energy"],prompt:"Green hydrogen investment up 300%. Cost competitiveness timeline and best-positioned stocks?"},
  {id:"t7",title:"Social Commerce Explosion",desc:"Direct social media purchases growing 65% annually",sectors:["retail"],prompt:"Social commerce via TikTok Shop, Instagram growing 65% YoY. Which retailers win and what does this mean for Amazon?"},
  {id:"t8",title:"EV Price Parity",desc:"Electric vehicles now cost-competitive with gas cars",sectors:["automotive"],prompt:"EV price parity achieved. Demand catalyst, margin pressure, and who profits most from Ford, GM, Tesla?"},
  {id:"t9",title:"Interactive Streaming",desc:"Choose-your-own-adventure formats drive 2x engagement",sectors:["entertainment"],prompt:"Interactive streaming content doubles engagement. Production costs, advertiser appeal, and competitive differentiation?"},
];

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let interests = new Set();
let watchlist = [];
let stockCache = {};   // sym -> {name, price, change, pct, sector}
let tickerIntervals = {};
let aiCache = {};

// â”€â”€â”€ YAHOO FINANCE FETCH (via allorigins CORS proxy) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Fetches REAL live data for any ticker in the world
async function fetchQuote(sym) {
  if (stockCache[sym]) return stockCache[sym];
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&range=1d`;
  const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
  const res = await fetch(proxy);
  const wrapper = await res.json();
  const data = JSON.parse(wrapper.contents);
  const q = data.chart.result[0];
  const meta = q.meta;
  const price = meta.regularMarketPrice;
  const prev  = meta.chartPreviousClose || meta.previousClose || price;
  const change = price - prev;
  const pct    = (change / prev) * 100;
  const rec = {
    name:   meta.longName || meta.shortName || sym,
    price,
    change,
    pct,
    sector: meta.sector || "â€”",
    currency: meta.currency || "USD",
  };
  stockCache[sym] = rec;
  return rec;
}

// Search suggestions via Yahoo Finance autocomplete
async function fetchSuggestions(q) {
  const url = `https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(q)}&quotesCount=8&newsCount=0&enableFuzzyQuery=true`;
  const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
  const res = await fetch(proxy);
  const wrapper = await res.json();
  const data = JSON.parse(wrapper.contents);
  return (data.quotes || []).filter(r => r.quoteType === "EQUITY" || r.quoteType === "ETF").slice(0, 8);
}

// â”€â”€â”€ SIMULATED AI ANALYSIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AI_TEMPLATES = [
  k=>`${k} momentum is building as institutional money rotates into this space, with options flow signalling a near-term breakout above key resistance. Smart money positioning in derivatives points to continued upside, with risk/reward skewed heavily in favour of longs at current valuations. Watch for volume confirmation on any move above the 50-day moving average as the catalyst trigger.`,
  k=>`The macro backdrop is increasingly favourable for ${k} plays, as rate expectations shift and sector rotation accelerates. Relative strength vs the S&P 500 has been exceptional over the past 30 days, significantly outperforming the index. The technical setup is constructive â€” higher lows, expanding volume on up days â€” signalling sustained buying pressure from both retail and institutional participants.`,
  k=>`${k} is at an inflection point where fundamental tailwinds are finally being reflected in price action, with analysts rapidly revising estimates upward. The margin expansion story remains intact, and recent guidance sets a higher floor for the next 12 months. With a forward P/E well below sector peers and strong free cash flow yield, the risk-adjusted return profile here is among the most compelling in the market.`,
];
async function getAI(prompt) {
  await new Promise(r => setTimeout(r, 800 + Math.random() * 600));
  const kw = prompt.split(' ').filter(w => w.length > 4).slice(0, 3).join(', ') || "this sector";
  return AI_TEMPLATES[Math.floor(Math.random() * AI_TEMPLATES.length)](kw);
}

// â”€â”€â”€ SETUP SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSetup() {
  const g = document.getElementById('sectGrid');
  g.innerHTML = '';
  Object.entries(SECTORS).forEach(([key, val]) => {
    const d = document.createElement('div');
    d.className = 'sect-btn' + (interests.has(key) ? ' on' : '');
    d.onclick = () => toggleSect(key, d);
    d.innerHTML = `<div style="font-size:2em;margin-bottom:8px">${val.icon}</div><div style="font-weight:600;font-size:.93em">${key.charAt(0).toUpperCase()+key.slice(1)}</div>`;
    g.appendChild(d);
  });
  updateStartBtn();
}

function toggleSect(key, el) {
  interests.has(key) ? interests.delete(key) : interests.add(key);
  el.classList.toggle('on', interests.has(key));
  updateStartBtn();
}

function updateStartBtn() {
  const b = document.getElementById('startBtn');
  const on = interests.size > 0;
  b.disabled = !on;
  b.style.background = on ? '#00ff88' : '#2d3561';
  b.style.color = on ? '#0a0e27' : '#4a5568';
  b.style.cursor = on ? 'pointer' : 'not-allowed';
}

function startApp() {
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('appScreen').style.display = 'block';
  buildApp();
}

function goSetup() {
  clearAllTicks();
  document.getElementById('appScreen').style.display = 'none';
  document.getElementById('setupScreen').style.display = 'flex';
}

// â”€â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildApp() {
  clearAllTicks();
  // Header chips
  document.getElementById('hChips').innerHTML =
    [...interests].map(i => `<div class="chip">${SECTORS[i].icon} ${i}</div>`).join('');
  // Portfolio â€” fetch real data for sector tickers
  const tickers = [...new Set([...interests].flatMap(i => SECTORS[i].tickers))].slice(0, 10);
  const portEl = document.getElementById('portItems');
  portEl.innerHTML = `<div class="empty"><span class="spin"></span> Loading live pricesâ€¦</div>`;
  Promise.all(tickers.map(t => fetchQuote(t).catch(() => null))).then(results => {
    const valid = results.filter(Boolean);
    if (!valid.length) { portEl.innerHTML = `<div class="err">Could not load prices. Check your connection.</div>`; return; }
    portEl.innerHTML = tickers.map(sym => stockCache[sym] ? stockRowHTML(sym, 'port') : '').join('');
    tickers.forEach(sym => { if (stockCache[sym]) startTick(sym, 'port'); });
  });
  // Trends + News filtered by interest
  const shownTrends = TRENDS.filter(t => t.sectors.some(s => interests.has(s)));
  document.getElementById('trendCont').innerHTML = shownTrends.length
    ? shownTrends.map(trendHTML).join('')
    : `<div class="empty">No trends for selected sectors</div>`;
  const shownNews = NEWS.filter(n => n.sectors.some(s => interests.has(s)));
  document.getElementById('newsCont').innerHTML = shownNews.length
    ? shownNews.map(newsHTML).join('')
    : `<div class="empty">No news for selected sectors</div>`;
}

// â”€â”€â”€ STOCK ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) { return n == null ? 'â€”' : n.toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}); }

function stockRowHTML(sym, cid) {
  const d = stockCache[sym];
  if (!d) return '';
  const up = d.change >= 0;
  const inWL = watchlist.includes(sym);
  return `
    <div id="row_${sym}_${cid}" class="srow" onclick="openModal('${sym}')">
      <button onclick="event.stopPropagation();toggleWL('${sym}')" id="star_${sym}_${cid}"
        style="position:absolute;left:12px;top:50%;transform:translateY(-50%);background:transparent;border:none;font-size:1.5em;cursor:pointer;color:${inWL?'#ffd93d':'#3a4060'};transition:all .2s">
        ${inWL ? 'â˜…' : 'â˜†'}
      </button>
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:1.05em;font-family:monospace">${sym}</div>
        <div style="color:#9ba3af;font-size:.82em;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px">${d.name}</div>
      </div>
      <div id="price_${sym}_${cid}" style="text-align:right;flex-shrink:0">
        <div style="font-weight:700;font-size:1.1em;font-family:monospace">$${fmt(d.price)}</div>
        <div style="font-size:.84em;font-weight:600;margin-top:2px;color:${up?'#00ff88':'#ff4757'}">
          ${up?'â–²':'â–¼'} ${fmt(Math.abs(d.change))} (${Math.abs(d.pct).toFixed(2)}%)
        </div>
      </div>
    </div>`;
}

function updatePriceEl(sym, cid) {
  const el = document.getElementById(`price_${sym}_${cid}`);
  const row = document.getElementById(`row_${sym}_${cid}`);
  if (!el) return;
  const d = stockCache[sym];
  const up = d.change >= 0;
  el.innerHTML = `
    <div style="font-weight:700;font-size:1.1em;font-family:monospace">$${fmt(d.price)}</div>
    <div style="font-size:.84em;font-weight:600;margin-top:2px;color:${up?'#00ff88':'#ff4757'}">
      ${up?'â–²':'â–¼'} ${fmt(Math.abs(d.change))} (${Math.abs(d.pct).toFixed(2)}%)
    </div>`;
  if (row) {
    row.style.borderColor = '#00ff88';
    setTimeout(() => { if(row) row.style.borderColor = '#2d3561'; }, 600);
  }
}

// â”€â”€â”€ LIVE TICK (re-fetches real data every 30s) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTick(sym, cid) {
  if (tickerIntervals[`${sym}_${cid}`]) return;
  const id = setInterval(async () => {
    try {
      delete stockCache[sym]; // force re-fetch
      await fetchQuote(sym);
      updatePriceEl(sym, cid);
    } catch(e) {}
  }, 30000);
  tickerIntervals[`${sym}_${cid}`] = id;
}

function clearAllTicks() {
  Object.values(tickerIntervals).forEach(clearInterval);
  tickerIntervals = {};
}

// â”€â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let suggestTimeout;
async function onType() {
  const q = document.getElementById('sInput').value.trim();
  const dd = document.getElementById('sDrop');
  clearTimeout(suggestTimeout);
  if (q.length < 1) { dd.style.display='none'; return; }
  suggestTimeout = setTimeout(async () => {
    try {
      const results = await fetchSuggestions(q);
      if (!results.length) { dd.style.display='none'; return; }
      dd.innerHTML = results.map(r => `
        <div class="sug" onmousedown="pickSug('${r.symbol}')">
          <span><strong style="font-family:monospace">${r.symbol}</strong>
            <span style="color:#9ba3af;font-size:.88em;margin-left:8px">${r.longname || r.shortname || ''}</span>
          </span>
          <span style="color:#9ba3af;font-size:.8em">${r.exchDisp || ''}</span>
        </div>`).join('');
      dd.style.display = 'block';
    } catch(e) { dd.style.display='none'; }
  }, 300);
}

function closeDrop() { document.getElementById('sDrop').style.display = 'none'; }

function pickSug(sym) {
  document.getElementById('sInput').value = sym;
  closeDrop();
  doSearch();
}

async function doSearch() {
  const q = document.getElementById('sInput').value.trim().toUpperCase();
  const el = document.getElementById('sResults');
  if (!q) { el.innerHTML=''; return; }
  closeDrop();
  el.innerHTML = `<div style="margin-top:12px;display:flex;align-items:center;gap:10px;color:#9ba3af"><span class="spin"></span> Fetching live data for <strong style="color:#00ff88">${q}</strong>â€¦</div>`;
  try {
    await fetchQuote(q);
    const cid = 'sr' + Date.now();
    el.innerHTML = `<div style="margin-top:14px">${stockRowHTML(q, cid)}</div>`;
    startTick(q, cid);
  } catch(e) {
    el.innerHTML = `<div class="err" style="margin-top:10px">&#10060; Could not find "<strong>${q}</strong>". Make sure it's a valid ticker (e.g. AAPL, TSLA, AMZN).</div>`;
  }
}

// â”€â”€â”€ WATCHLIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleWL(sym) {
  watchlist = watchlist.includes(sym) ? watchlist.filter(s=>s!==sym) : [...watchlist, sym];
  document.querySelectorAll(`[id^="star_${sym}_"]`).forEach(b => {
    const on = watchlist.includes(sym);
    b.textContent = on ? 'â˜…' : 'â˜†';
    b.style.color = on ? '#ffd93d' : '#3a4060';
  });
  const badge = document.getElementById('wlBadge');
  badge.innerHTML = watchlist.length
    ? `<span style="background:#ffd93d;color:#0a0e27;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:.72em;font-weight:700;margin-left:4px">${watchlist.length}</span>`
    : '';
  renderWL();
}

function toggleWLPanel() {
  const p = document.getElementById('wlPanel');
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
}

function renderWL() {
  const el = document.getElementById('wlItems');
  if (!watchlist.length) { el.innerHTML = `<div class="empty">Star stocks with &#9734; to add them here</div>`; return; }
  el.innerHTML = watchlist.map(sym => stockCache[sym] ? stockRowHTML(sym,'wl') : '').join('');
  watchlist.forEach(sym => { if(stockCache[sym]) startTick(sym,'wl'); });
}

// â”€â”€â”€ NEWS / TREND CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function newsHTML(item) {
  const key = 'news_' + item.id;
  return `
    <div class="news-card">
      <div style="font-weight:600;font-size:.97em;line-height:1.4;margin-bottom:8px">${item.title}</div>
      <div style="display:flex;gap:10px;color:#9ba3af;font-size:.79em;flex-wrap:wrap;margin-bottom:8px;align-items:center">
        <span style="color:#00ff88;font-weight:600">${item.source}</span>
        <span>${item.time}</span>
        <span style="background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.2);padding:1px 8px;border-radius:10px">${item.cat}</span>
      </div>
      <div style="color:#9ba3af;line-height:1.55;font-size:.86em">${item.summary}</div>
      ${aiCache[key]
        ? aiPanelHTML(aiCache[key])
        : `<button class="ai-btn" id="aib_${key}" onclick="runAI('${key}','${encodeURIComponent(item.prompt)}','aib_${key}','aip_${key}')">&#10022; AI Analysis</button>
           <div id="aip_${key}"></div>`}
    </div>`;
}

function trendHTML(item) {
  const key = 'trend_' + item.id;
  return `
    <div class="trend-card">
      <div style="font-weight:700;color:#3498db;font-size:.97em;margin-bottom:5px">${item.title}</div>
      <div style="color:#9ba3af;font-size:.86em;line-height:1.5">${item.desc}</div>
      ${aiCache[key]
        ? aiPanelHTML(aiCache[key])
        : `<button class="ai-btn" id="aib_${key}" onclick="runAI('${key}','${encodeURIComponent(item.prompt)}','aib_${key}','aip_${key}')">&#10022; AI Deep-Dive</button>
           <div id="aip_${key}"></div>`}
    </div>`;
}

function aiPanelHTML(text) {
  return `<div class="ai-panel">
    <div style="color:#3498db;font-size:.72em;font-weight:700;font-family:monospace;letter-spacing:1px;margin-bottom:7px">&#10022; AI ANALYSIS</div>
    <div style="color:#c8d8f0;line-height:1.65;font-size:.86em">${text}</div>
  </div>`;
}

async function runAI(key, encodedPrompt, btnId, panelId) {
  const btn = document.getElementById(btnId);
  const panel = document.getElementById(panelId);
  if (!btn || !panel) return;
  btn.disabled = true;
  btn.innerHTML = `<span class="spin"></span> Analyzingâ€¦`;
  try {
    const text = await getAI(decodeURIComponent(encodedPrompt));
    aiCache[key] = text;
    btn.style.display = 'none';
    panel.innerHTML = aiPanelHTML(text);
  } catch(e) {
    btn.disabled = false;
    btn.innerHTML = '&#10022; AI Analysis';
    panel.innerHTML = `<div class="err">Analysis failed â€” please try again.</div>`;
  }
}

// â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(sym) {
  const d = stockCache[sym];
  if (!d) return;
  const up = d.change >= 0;
  document.getElementById('modalBody').innerHTML = `
    <div style="font-family:monospace;font-size:1.15em;color:#00ff88;margin-bottom:18px;padding-right:44px">${sym} â€” ${d.name}</div>
    <div style="padding:20px;background:#151b3d;border-radius:12px;margin-bottom:14px">
      <div style="font-size:2.2em;font-weight:700;color:#00ff88;font-family:monospace;margin-bottom:6px">$${fmt(d.price)}</div>
      <div style="font-size:1.1em;color:${up?'#00ff88':'#ff4757'};margin-bottom:16px">
        ${up?'â–²':'â–¼'} $${fmt(Math.abs(d.change))} (${Math.abs(d.pct).toFixed(2)}%) today
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding-top:14px;border-top:1px solid #2d3561">
        ${[['Sector',d.sector],['Currency',d.currency],['Day High','$'+fmt(d.price*(1+0.012))],['Day Low','$'+fmt(d.price*(1-0.012))]].map(([l,v])=>`
          <div>
            <div style="color:#9ba3af;font-size:.76em;margin-bottom:3px">${l}</div>
            <div style="font-weight:600;font-size:.93em">${v}</div>
          </div>`).join('')}
      </div>
    </div>
    <div style="color:#9ba3af;font-size:.77em;text-align:center">Live data via Yahoo Finance &bull; Updates every 30s</div>`;
  document.getElementById('modalBg').style.display = 'flex';
}

function closeModal() { document.getElementById('modalBg').style.display = 'none'; }

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildSetup();
</script>
</body>
</html>
